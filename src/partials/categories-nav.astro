---
import { getCollection } from 'astro:content'

interface Props {
    lang: string
}

type Category = {id:number, count: number}

const {lang} = Astro.props
const langsMeta = await getCollection('meta')
const currentLangMeta = langsMeta.filter((langMeta) => langMeta.id === lang)[0]
const getCategory = (categoryId:number) => {
    const category = currentLangMeta.data.categories.find(category => category.id === categoryId)
    return category
}

const posts = await getCollection('posts')
const postsCategories = posts.reduce((acc: Record<number, Category>, post) => {
    const categoryId = post.data['category-id']
  
    if (acc[categoryId]) {
        acc[categoryId].count++
    } else {
        acc[categoryId] = { id: categoryId, count: 1 }
    }
  
    return acc
}, {})

const categoriesCollection: Category[] = Object.values(postsCategories)
---
<ul class="flex flex-wrap gap-4">
    {
        categoriesCollection.map(category => {
            return <li class="border border-black-dark rounded-md overflow-hidden [&:hover]:bg-white-dark">
                <a href={`/${lang}/${getCategory(category.id)?.slug}/1/`} class="flex justify-between">
                    <span class="category-name text-base-1 capitalize leading-base-1 px-4">{getCategory(category.id)?.name}</span>
                    <span class="category-count flex items-center bg-black-dark text-sm-1 text-white-light px-4 py-1 self-stretch">{category.count}</span>
                </a>
            </li>
        })
    }
</ul>